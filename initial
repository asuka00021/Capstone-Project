
R version 3.5.0 (2018-04-23) -- "Joy in Playing"
Copyright (C) 2018 The R Foundation for Statistical Computing
Platform: x86_64-w64-mingw32/x64 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Workspace loaded from ~/.RData]

> wine = read.csv("C:/Users/wangch/Documents/CKME136/wine-reviews/winemag-data-130k-v2.csv", header =TRUE)
> library(ggplot2)
Warning message:
package ‘ggplot2’ was built under R version 3.5.1 
> # data cleansing - identify missing data




> summary(wine)
       X              country     
 Min.   :     0   US      :54504  
 1st Qu.: 32493   France  :22093  
 Median : 64985   Italy   :19540  
 Mean   : 64985   Spain   : 6645  
 3rd Qu.: 97478   Portugal: 5691  
 Max.   :129970   Chile   : 4472  
                  (Other) :17026  
                                                                                                                                                                                                                                                                                                        description    
 Cigar box, cafÃ© au lait, and dried tobacco aromas are followed by coffee and cherry flavors, with barrel spices lingering on the finish. The wood gets a bit out front but it still delivers enjoyment.                                                                                                     :     3  
 Gravenstein apple, honeysuckle and jasmine aromas show on the relatively boisterous nose of this bottling from a large vineyard on Highway 46 east of Paso Robles. There is compellingly grippy texture to the sip, with ripe flavors of pear and honeydew melon. A salty acidity takes it to the next level.:     3  
 Ripe plum, game, truffle, leather and menthol are some of the aromas you'll find on this earthy wine. The tightly wound palate offers dried black cherry, chopped sage, mint and roasted coffee bean alongside raspy tannins that leave a mouth-drying finish.                                               :     3  
 Seductively tart in lemon pith, cranberry and pomegranate, this refreshing, light-bodied quaff is infinitely enjoyable, both on its own or at the table. It continues to expand on the palate into an increasing array of fresh flavors, finishing in cherry and orange.                                     :     3  
 Stalky aromas suggest hay and green herbs, with raspberry in the backdrop. It's hot and short in terms of mouthfeel, with herbal flavors leading the way and berry fruit running behind. Dry red fruit and herbal notes dominate the finish.                                                                 :     3  
 This zesty red has pretty aromas that suggest small red berry, blue flower and a whiff of moist soil. The vibrant palate offers sour cherry, pomegranate and a hint of anise alongside zesty acidity and refined tannins.                                                                                    :     3  
 (Other)                                                                                                                                                                                                                                                                                                      :129953  
       designation        points           price               province    
             :37465   Min.   : 80.00   Min.   :   4.00   California:36247  
 Reserve     : 2009   1st Qu.: 86.00   1st Qu.:  17.00   Washington: 8639  
 Estate      : 1322   Median : 88.00   Median :  25.00   Bordeaux  : 5941  
 Reserva     : 1259   Mean   : 88.45   Mean   :  35.36   Tuscany   : 5897  
 Riserva     :  698   3rd Qu.: 91.00   3rd Qu.:  42.00   Oregon    : 5373  
 Estate Grown:  621   Max.   :100.00   Max.   :3300.00   Burgundy  : 3980  
 (Other)     :86597                    NA's   :8996      (Other)   :63894  
                 region_1                  region_2                taster_name   
                     :21247                    :79460                    :26244  
 Napa Valley         : 4480   Central Coast    :11065   Roger Voss       :25514  
 Columbia Valley (WA): 4124   Sonoma           : 9028   Michael Schachner:15134  
 Russian River Valley: 3091   Columbia Valley  : 8103   Kerin Oâ€™Keefe  :10776  
 California          : 2629   Napa             : 6814   Virginie Boone   : 9537  
 Paso Robles         : 2350   Willamette Valley: 3423   Paul Gregutt     : 9532  
 (Other)             :92050   (Other)          :12078   (Other)          :33234  
  taster_twitter_handle                                                     title       
             :31213     Gloria Ferrer NV Sonoma Brut Sparkling (Sonoma County) :    11  
 @vossroger  :25514     Korbel NV Brut Sparkling (California)                  :     9  
 @wineschach :15134     Segura Viudas NV Extra Dry Sparkling (Cava)            :     8  
 @kerinokeefe:10776     Gloria Ferrer NV Blanc de Noirs Sparkling (Carneros)   :     7  
 @vboone     : 9537     Ruinart NV Brut RosÃ©  (Champagne)                     :     7  
 @paulgwineÂ : 9532     Segura Viudas NV Aria Estate Extra Dry Sparkling (Cava):     7  
 (Other)     :28265     (Other)                                                :129922  
                     variety                     winery      
 Pinot Noir              :13272   Wines & Winemakers:   222  
 Chardonnay              :11753   Testarossa        :   218  
 Cabernet Sauvignon      : 9472   DFJ Vinhos        :   215  
 Red Blend               : 8946   Williams Selyem   :   211  
 Bordeaux-style Red Blend: 6915   Louis Latour      :   199  
 Riesling                : 5189   Georges Duboeuf   :   196  
 (Other)                 :74424   (Other)           :128710  



> print(colSums(is.na(wine)))
                   X1               country           description           designation                points 
                    0                    63                     0                 37465                     0 
                price              province              region_1              region_2           taster_name 
                 8996                    63                 21247                 79460                 26244 
taster_twitter_handle                 title               variety                winery 
                31213                     0                     1                     0 


> #replace missing price with median price
> wine$price[is.na(wine$price)]<-median(wine$price,na.rm=TRUE)

> summary(wine)
       X              country     
 Min.   :     0   US      :54504  
 1st Qu.: 32493   France  :22093  
 Median : 64985   Italy   :19540  
 Mean   : 64985   Spain   : 6645  
 3rd Qu.: 97478   Portugal: 5691  
 Max.   :129970   Chile   : 4472  
                  (Other) :17026  
                                                                                                                                                                                                                                                                                                        description    
 Cigar box, cafÃ© au lait, and dried tobacco aromas are followed by coffee and cherry flavors, with barrel spices lingering on the finish. The wood gets a bit out front but it still delivers enjoyment.                                                                                                     :     3  
 Gravenstein apple, honeysuckle and jasmine aromas show on the relatively boisterous nose of this bottling from a large vineyard on Highway 46 east of Paso Robles. There is compellingly grippy texture to the sip, with ripe flavors of pear and honeydew melon. A salty acidity takes it to the next level.:     3  
 Ripe plum, game, truffle, leather and menthol are some of the aromas you'll find on this earthy wine. The tightly wound palate offers dried black cherry, chopped sage, mint and roasted coffee bean alongside raspy tannins that leave a mouth-drying finish.                                               :     3  
 Seductively tart in lemon pith, cranberry and pomegranate, this refreshing, light-bodied quaff is infinitely enjoyable, both on its own or at the table. It continues to expand on the palate into an increasing array of fresh flavors, finishing in cherry and orange.                                     :     3  
 Stalky aromas suggest hay and green herbs, with raspberry in the backdrop. It's hot and short in terms of mouthfeel, with herbal flavors leading the way and berry fruit running behind. Dry red fruit and herbal notes dominate the finish.                                                                 :     3  
 This zesty red has pretty aromas that suggest small red berry, blue flower and a whiff of moist soil. The vibrant palate offers sour cherry, pomegranate and a hint of anise alongside zesty acidity and refined tannins.                                                                                    :     3  
 (Other)                                                                                                                                                                                                                                                                                                      :129953  
       designation        points           price               province    
             :37465   Min.   : 80.00   Min.   :   4.00   California:36247  
 Reserve     : 2009   1st Qu.: 86.00   1st Qu.:  18.00   Washington: 8639  
 Estate      : 1322   Median : 88.00   Median :  25.00   Bordeaux  : 5941  
 Reserva     : 1259   Mean   : 88.45   Mean   :  34.65   Tuscany   : 5897  
 Riserva     :  698   3rd Qu.: 91.00   3rd Qu.:  40.00   Oregon    : 5373  
 Estate Grown:  621   Max.   :100.00   Max.   :3300.00   Burgundy  : 3980  
 (Other)     :86597                                      (Other)   :63894  
                 region_1                  region_2                taster_name   
                     :21247                    :79460                    :26244  
 Napa Valley         : 4480   Central Coast    :11065   Roger Voss       :25514  
 Columbia Valley (WA): 4124   Sonoma           : 9028   Michael Schachner:15134  
 Russian River Valley: 3091   Columbia Valley  : 8103   Kerin Oâ€™Keefe  :10776  
 California          : 2629   Napa             : 6814   Virginie Boone   : 9537  
 Paso Robles         : 2350   Willamette Valley: 3423   Paul Gregutt     : 9532  
 (Other)             :92050   (Other)          :12078   (Other)          :33234  
  taster_twitter_handle                                                     title       
             :31213     Gloria Ferrer NV Sonoma Brut Sparkling (Sonoma County) :    11  
 @vossroger  :25514     Korbel NV Brut Sparkling (California)                  :     9  
 @wineschach :15134     Segura Viudas NV Extra Dry Sparkling (Cava)            :     8  
 @kerinokeefe:10776     Gloria Ferrer NV Blanc de Noirs Sparkling (Carneros)   :     7  
 @vboone     : 9537     Ruinart NV Brut RosÃ©  (Champagne)                     :     7  
 @paulgwineÂ : 9532     Segura Viudas NV Aria Estate Extra Dry Sparkling (Cava):     7  
 (Other)     :28265     (Other)                                                :129922  
                     variety                     winery      
 Pinot Noir              :13272   Wines & Winemakers:   222  
 Chardonnay              :11753   Testarossa        :   218  
 Cabernet Sauvignon      : 9472   DFJ Vinhos        :   215  
 Red Blend               : 8946   Williams Selyem   :   211  
 Bordeaux-style Red Blend: 6915   Louis Latour      :   199  
 Riesling                : 5189   Georges Duboeuf   :   196  
 (Other)                 :74424   (Other)           :128710  



> unique_vals<-lapply(wine, unique)
> sapply(unique_vals, length)
                   X1               country           description           designation                points 
               129971                    44                119955                 37980                    21 
                price              province              region_1              region_2           taster_name 
                  390                   426                  1230                    18                    20 
taster_twitter_handle                 title               variety                winery 
                   16                118840                   708                 16757 


> sapply(wine,class)
                    X               country           description           designation 
            "integer"              "factor"              "factor"              "factor" 
               points                 price              province              region_1 
            "integer"             "integer"              "factor"              "factor" 
             region_2           taster_name taster_twitter_handle                 title 
             "factor"              "factor"              "factor"              "factor" 
              variety                winery 
             "factor"              "factor" 

#INSPECT THE POINTS
> > library(ggplot2)
> ggplot(wine, aes(x = points))
> hist(wine$points)


> summary(wine$points)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  80.00   86.00   88.00   88.45   91.00  100.00 


> sum(wine$points == 100)
[1] 19
> sum(wine$points == 80)
[1] 397

#points are mostly normally distrinbuted (also sample size is large enough should be normally distributed)

> library(outliers)
Warning message:
package ‘outliers’ was built under R version 3.5.2 
> outlier(wine$price, opposite=TRUE)
[1] 4
> outlier(wine$price, opposite=FALSE)
[1] 3300
> # price 4 and 3300 are both outlier of the wine price

> summary(wine$price)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   4.00   18.00   25.00   34.65   40.00 3300.00 
> boxplot(wine$price)
> # the price point $3000 is the outlier that we need to figure out what to do with

> wine %>% filter(wine$price > 1000)
# A tibble: 14 x 14
       X1 country description designation points price province region_1 region_2 taster_name taster_twitter_~ title
    <dbl> <chr>   <chr>       <chr>        <dbl> <dbl> <chr>    <chr>    <chr>    <chr>       <chr>            <chr>
 1   1558 France  A massive ~ NA              98  1900 Bordeaux Margaux  NA       Roger Voss  @vossroger       Chât~
 2   1566 France  Such a gen~ NA              97  1100 Bordeaux Pessac-~ NA       Roger Voss  @vossroger       Chât~
 3   1571 France  Solid, ver~ NA              96  1200 Bordeaux Pessac-~ NA       Roger Voss  @vossroger       Chât~
 4   1575 France  The purest~ NA              96  1300 Bordeaux Pauillac NA       Roger Voss  @vossroger       Chât~
 5  15840 France  The wine i~ NA              96  2500 Bordeaux Pomerol  NA       Roger Voss  @vossroger       Chât~
 6  65352 France  This extra~ NA              97  2000 Bordeaux Pomerol  NA       Roger Voss  @vossroger       Chât~
 7  80290 France  This ripe ~ NA              88  3300 Bordeaux Médoc    NA       Roger Voss  @vossroger       Chât~
 8  89478 Austria Wet earth,~ Ried Loibe~     94  1100 Wachau   NA       NA       Anne Krebi~ @AnneInVino      Emme~
 9  98380 France  A superb w~ NA              96  2500 Burgundy La Roma~ NA       Roger Voss  @vossroger       Doma~
10 111753 France  Almost bla~ NA             100  1500 Bordeaux Pauillac NA       Roger Voss  @vossroger       Chât~
11 111755 France  This is th~ NA             100  1500 Bordeaux Saint-É~ NA       Roger Voss  @vossroger       Chât~
12 113564 France  A wonderfu~ NA              96  2000 Burgundy La Roma~ NA       Roger Voss  @vossroger       Doma~
13 113581 France  While it s~ NA              94  1125 Burgundy La Roma~ NA       Roger Voss  @vossroger       Doma~
14 120391 US      The nose o~ Roger Rose~     91  2013 Califor~ Arroyo ~ Central~ Matt Kettm~ @mattkettmann    Blai~
# ... with 2 more variables: variety <chr>, winery <chr>
> sum(wine$price > 1000, na.rm = TRUE)
[1] 14
> sum(wine$price > 500, na.rm = TRUE)
[1] 91


> ggplot(data = wine, aes(x= price, colour = I('black'), fill = I('#099DD9')))+
+     geom_histogram()+
+     labs(x = "Price", y= "Frequency", title = "Distribution of log(prices)") #slightly right skewed
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.

> wine$logprice <- log(wine$price)
> ggplot(data = wine, aes(x= log(price), colour = I('black'), fill = I('#099DD9')))+
+     geom_histogram()+
+     labs(x = "log(Price)", y= "Frequency", title = "Distribution of log(prices)") #slightly right skewed

> hist(wine$price)
> hist(wine$points, main = "points histogram", xlab = "points")
> #points are mostly normally distrinbuted (also sample size is large enough should be normally distributed), also tranform to log price 

#inspect correlations between numerical variable
> cor(wine$price, wine$points)
[1] 0.3992309
> cor(wine$logprice, wine$points)
[1] 0.5896118

# inspect correlation between categorical variable with points and price
> > chisq.test(wine$country, wine$points, correct = FALSE)

	Pearson's Chi-squared test

data:  wine$country and wine$points
X-squared = 11699, df = 840, p-value < 2.2e-16
> chisq.test(wine$country, wine$price, correct = FALSE)

	Pearson's Chi-squared test

data:  wine$country and wine$price
X-squared = 51022, df = 16338, p-value < 2.2e-16

Warning message:
In chisq.test(wine$country, wine$price, correct = FALSE) :
  Chi-squared approximation may be incorrect
  > chisq.test(wine$winery, wine$points, correct = FALSE)

	Pearson's Chi-squared test

data:  wine$winery and wine$points
X-squared = 453230, df = 335120, p-value < 2.2e-16

Warning message:
In chisq.test(wine$winery, wine$points, correct = FALSE) :
  Chi-squared approximation may be incorrect
> chisq.test(wine$variety, wine$points, correct = FALSE)

	Pearson's Chi-squared test

data:  wine$variety and wine$points
X-squared = 31759, df = 14120, p-value < 2.2e-16

Warning message:
In chisq.test(wine$variety, wine$points, correct = FALSE) :
  Chi-squared approximation may be incorrect
> 




#install tidyr
> library(ggplot2)
> library(tidyr)
Warning message:
package ‘tidyr’ was built under R version 3.5.1 
> library(tm)
Loading required package: NLP

Attaching package: ‘NLP’

The following object is masked from ‘package:ggplot2’:

    annotate

Warning messages:
1: package ‘tm’ was built under R version 3.5.2 
2: package ‘NLP’ was built under R version 3.5.2 
> library(dplyr)

Attaching package: ‘dplyr’

The following objects are masked from ‘package:dbplyr’:

    ident, sql

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

Warning message:
package ‘dplyr’ was built under R version 3.5.1 
> library(ggjoy)
Error in library(ggjoy) : there is no package called ‘ggjoy’
> install.packages("ggjoy")
Installing package into ‘C:/Users/wangch/Documents/R/win-library/3.5’
(as ‘lib’ is unspecified)
also installing the dependency ‘ggridges’

trying URL 'https://cran.rstudio.com/bin/windows/contrib/3.5/ggridges_0.5.1.zip'
Warning in install.packages :
  InternetOpenUrl failed: 'The server name or address could not be resolved'
Error in download.file(url, destfile, method, mode = "wb", ...) : 
  cannot open URL 'https://cran.rstudio.com/bin/windows/contrib/3.5/ggridges_0.5.1.zip'
Warning in install.packages :
  download of package ‘ggridges’ failed
trying URL 'https://cran.rstudio.com/bin/windows/contrib/3.5/ggjoy_0.4.1.zip'
Warning in install.packages :
  InternetOpenUrl failed: 'The connection with the server was reset'
Error in download.file(url, destfile, method, mode = "wb", ...) : 
  cannot open URL 'https://cran.rstudio.com/bin/windows/contrib/3.5/ggjoy_0.4.1.zip'
Warning in install.packages :
  download of package ‘ggjoy’ failed
> library("gridExtra")
Error in library("gridExtra") : there is no package called ‘gridExtra’
> library(gridExtra)
Error in library(gridExtra) : there is no package called ‘gridExtra’
> install.packages("gridExtra")
Installing package into ‘C:/Users/wangch/Documents/R/win-library/3.5’
(as ‘lib’ is unspecified)
trying URL 'https://cran.rstudio.com/bin/windows/contrib/3.5/gridExtra_2.3.zip'
Content type 'application/zip' length 1108441 bytes (1.1 MB)
downloaded 1.1 MB

package ‘gridExtra’ successfully unpacked and MD5 sums checked

The downloaded binary packages are in
	C:\Users\wangch\AppData\Local\Temp\Rtmps7Mbic\downloaded_packages
> library(gridExtra)

Attaching package: ‘gridExtra’

The following object is masked from ‘package:dplyr’:

    combine

Warning message:
package ‘gridExtra’ was built under R version 3.5.2 
> library(readr)
Warning message:
package ‘readr’ was built under R version 3.5.1 
> library(lightgbm)
Error in library(lightgbm) : there is no package called ‘lightgbm’
> install.packages("lightgbm")
Installing package into ‘C:/Users/wangch/Documents/R/win-library/3.5’
(as ‘lib’ is unspecified)
Warning in install.packages :
  package ‘lightgbm’ is not available (for R version 3.5.0)
> library(text2vec)
text2vec is still in beta version - APIs can be changed.
For tutorials and examples visit http://text2vec.org.

For FAQ refer to
  1. https://stackoverflow.com/questions/tagged/text2vec?sort=newest
  2. https://github.com/dselivanov/text2vec/issues?utf8=%E2%9C%93&q=is%3Aissue%20label%3Aquestion
If you have questions please post them at StackOverflow and mark with 'text2vec' tag.

Attaching package: ‘text2vec’

The following object is masked _by_ ‘.GlobalEnv’:

    normalize

Warning message:
package ‘text2vec’ was built under R version 3.5.2 
> library(SnowballC)
Warning message:
package ‘SnowballC’ was built under R version 3.5.2 
> library(wordcloud2)
Warning message:
package ‘wordcloud2’ was built under R version 3.5.2 
> library(RColorBrewer)
> library(quanteda)
Package version: 1.4.1
Parallel computing: 2 of 4 threads used.
See https://quanteda.io for tutorials and examples.

Attaching package: ‘quanteda’

The following objects are masked from ‘package:tm’:

    as.DocumentTermMatrix, stopwords

The following object is masked from ‘package:utils’:

    View

Warning message:
package ‘quanteda’ was built under R version 3.5.2 
> library(tidyverse)
-- Attaching packages --------------------------------------- tidyverse 1.2.1 --
v tibble  1.4.2     v stringr 1.3.1
v purrr   0.2.5     v forcats 0.3.0
-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x NLP::annotate()      masks ggplot2::annotate()
x gridExtra::combine() masks dplyr::combine()
x dplyr::filter()      masks stats::filter()
x dplyr::ident()       masks dbplyr::ident()
x dplyr::lag()         masks stats::lag()
x dplyr::sql()         masks dbplyr::sql()
Warning messages:
1: package ‘tidyverse’ was built under R version 3.5.1 
2: package ‘tibble’ was built under R version 3.5.1 
3: package ‘purrr’ was built under R version 3.5.1 
4: package ‘stringr’ was built under R version 3.5.1 
5: package ‘forcats’ was built under R version 3.5.1 
> library(stringr)
> library(lubridate)

Attaching package: ‘lubridate’

The following object is masked from ‘package:base’:

    date

Warning message:
package ‘lubridate’ was built under R version 3.5.1 
> library(kableExtra)
Warning message:
package ‘kableExtra’ was built under R version 3.5.2 
> library(sqldf)
Loading required package: gsubfn
Loading required package: proto
Loading required package: RSQLite
Warning messages:
1: package ‘sqldf’ was built under R version 3.5.2 
2: package ‘gsubfn’ was built under R version 3.5.2 
3: package ‘proto’ was built under R version 3.5.2 
4: package ‘RSQLite’ was built under R version 3.5.2 
> library(htmlTable)
Warning message:
package ‘htmlTable’ was built under R version 3.5.2 
> wine %>%
+ group_by(country)%>%
+ filter(n() > 500) %>%
+ mutate(count = n()) %>%
+ mutate(avg = mean(points)) %>%
+ ggplot(aes(x = reorder(country, count))) +
+ geom_bar(fill = 'red')+
+ coord_flip() +
+ theme_classic() +
+ labs(x = 'country', y = 'count', title = "Popular Wines by Country")

> wine %>%
+ group_by(winery) %>%
+ filter(n() >500) %>%
+ mutate(count = n()) %>%
+ mutate(avg = mean(points)) %>%
+ ggplot(aes(x = reorder(winery, count))) +
+ geom_bar(fill = 'blue') +
+ coord_flip() +
+ theme_classic() +
+ labs(x = 'winery', y = 'count', title ="Popular Wines by Winery")

> summary(wine$winery)
         Wines & Winemakers                  Testarossa                  DFJ Vinhos 
                        222                         218                         215 
            Williams Selyem                Louis Latour             Georges Duboeuf 
                        211                         199                         196 
      Chateau Ste. Michelle               Concha y Toro              Columbia Crest 
                        194                         164                         159 
            Kendall-Jackson                      Siduri                Gary Farrell 
                        130                         126                         125 
                     Lynmar               Albert Bichot                      Montes 
                        118                         117                         117 
           Casa Santos Lima  Jean-Luc and Paul Aegerter                    Trapiche 
                        113                         113                         113 
                  Undurraga              Robert Mondavi                   Santa Ema 
                        113                         112                         112 
      Chanson PÃ¨re et Fils                 Fess Parker                   V. Sattui 
                        109                         108                         107 
                 Iron Horse                       Foxen                 Louis Jadot 
                        106                         105                         104 
                   Chehalem       Feudi di San Gregorio                    Maryhill 
                        102                         102                         102 
               BrÃ¼ndlmayer      Domaine Zind-Humbrecht                       Kunde 
                        101                         101                         101 
                 D'Arenberg            Dutton-Goldfield                 Terre Rouge 
                        100                         100                         100 
                  Errazuriz              Cameron Hughes          Henri de Villamont 
                         99                          98                          98 
          J. Portugal Ramos                     Kenwood                  Martin Ray 
                         98                          98                          98 
                Seven Hills                  Dr. Loosen           Georges Vigouroux 
                         98                          96                          96 
              Rodney Strong                      Calera                    Fenestra 
                         96                          95                          95 
                    Naggiar            Olivier Leflaive                 Casca Wines 
                         95                          95                          94 
             Joseph Drouhin                     J. Lohr           Lamoreaux Landing 
                         94                          93                          93 
                 Santa Rita          Kirkland Signature       Companhia das Quintas 
                         93                          91                          90 
                  Rock Wall                    Balletto                  Waterbrook 
                         90                          89                          89 
               Novelty Hill                     Sineann                    De Loach 
                         88                          88                          87 
           FranÃ§ois Lurton                   San Pedro                    DÃ£o Sul 
                         87                          87                          86 
                   Recanati                   Adelsheim          Domaines Devillard 
                         86                          85                          85 
              Gloria Ferrer                  Kuentz-Bas                    MorandÃ© 
                         85                          85                          85 
                  Bernardus             La Chablisienne                   Milbrandt 
                         84                          84                          84 
Willamette Valley Vineyards                 Buena Vista         Herdade do EsporÃ£o 
                         84                          83                          83 
                 Heron Hill                Santa Alicia              Santa Carolina 
                         83                          83                          83 
      Bouchard PÃ¨re & Fils                      Cayuse                       Hogue 
                         81                          81                          81 
             L'Ecole No. 41                     Aveleda           Barton & Guestier 
                         81                          80                          80 
                Castle Rock                 Schramsberg        J Vineyards & Winery 
                         80                          80                          78 
             Marimar Estate                      Mercer                     Abacela 
                         77                          77                          76 
                     Januik              Pride Mountain          Dry Creek Vineyard 
                         76                          76                          75 
            Henri Bourgeois                      Morgan              Clos La Chance 
                         75                          75                          74 
                    (Other) 
                     119777 
> wine %>%
+ group_by(winery) %>%
+ filter(n() >120) %>%
+ mutate(count = n()) %>%
+ mutate(avg = mean(points)) %>%
+ ggplot(aes(x = reorder(winery, count))) +
+ geom_bar(fill = 'Red') +
+ coord_flip() +
+ theme_classic() +
+ labs(x = 'winery', y = 'count', title = "Popular Wine by Winery")
# final result shows that Wines and WIne Maker are the most popular ones

> wine %>%
+ group_by(province) %>%
+ filter(n() > 1000) %>%
+ mutate(count = n()) %>%
+ mutate(avg = mean(points)) %>%
+ ggplot(aes(x = reorder(province, count))) +
+ geom_bar(fill = 'Red') +
+ coord_flip() +
+ theme_classic() +
+ labs(x = 'province', y = 'count', title = 'Popular WIne Province Global')
# final result shows that California wine provide most popular wine , follow by Washington and Bordeau

> wine %>%
+ group_by(variety) %>%
+ filter(n() >1000) %>%
+ mutate(count = n()) %>%
+ mutate(avg = mean(points)) %>%
+ ggplot(aes(x = reorder(variety, count))) +
+ geom_bar(fill = 'Red') +
+ coord_flip() +
+ theme_classic() +
+ labs(x = 'variety', y = 'count', title = "Most Popular Varietal")
#Pinot Noir and Chardonnay is the most popular two 

> htmlTable(sqldf("select variety, country, price, points, winery from wine where price > 1200 order by price desc"))

variety	country	price	points	winery
1	Bordeaux-style Red Blend	France	3300	88	Château les Ormes Sorbet
2	Bordeaux-style Red Blend	France	2500	96	Château Pétrus
3	Pinot Noir	France	2500	96	Domaine du Comte Liger-Belair
4	Chardonnay	US	2013	91	Blair
5	Bordeaux-style Red Blend	France	2000	97	Château Pétrus
6	Pinot Noir	France	2000	96	Domaine du Comte Liger-Belair
7	Bordeaux-style Red Blend	France	1900	98	Château Margaux
8	Bordeaux-style Red Blend	France	1500	100	Château Lafite Rothschild
9	Bordeaux-style Red Blend	France	1500	100	Château Cheval Blanc
10	Bordeaux-style Red Blend	France	1300	96	Château Mouton Rothschild


> #TOP 30 VARIETY REVIEW
> TOP30 <- wine %>%
+ group_by(variety) %>%
+ summarise(count = n()) %>%
+ arrange(desc(count))
> top_30df <- TOP30[1:30,1:2]
> top_30df
# A tibble: 30 x 2
   variety                  count
   <chr>                    <int>
 1 Pinot Noir               13272
 2 Chardonnay               11753
 3 Cabernet Sauvignon        9472
 4 Red Blend                 8946
 5 Bordeaux-style Red Blend  6915
 6 Riesling                  5189
 7 Sauvignon Blanc           4967
 8 Syrah                     4142
 9 Rosé                      3564
10 Merlot                    3102
# ... with 20 more rows

> wine$wine_type <- ifelse(wine$variety == "Chardonnay" | wine$variety == "Riesling" | wine$variety == "Sauvignon Blanc" | wine$variety == "White Blend" | wine$variety == "Sparkling Blend" | wine$variety == "Pinot Gris" | wine$variety == "Champagne Blend" | wine$variety == "GrÃ¼ner Veltliner" | wine$variety == "Pinot Grigio" | wine$variety == "Portuguese White" | wine$variety == "Viognier" | wine$variety == "GewÃ¼rztraminer" | wine$variety == "GewÃ¼rztraminer", "White Wine", "Red Wine")
> wine %>%
+ group_by(wine_type) %>%
+ summarise(total = n()) %>%
+ arrange(desc(total)) %>%
+ mutate(topcount = round(total/sum(total), digits = 2), accum = cumsum(topcount))
# A tibble: 3 x 4
  wine_type  total topcount accum
  <chr>      <int>    <dbl> <dbl>
1 Red Wine   89999     0.75  0.75
2 White Wine 29955     0.25  1   
3 NA             1     0     1   
# top country
#the N/A of country is only 63 rows - so immaterial to teh total reviews and could be ignore, just remove any duplicate first


> winecountry <- wine %>%
+ group_by(country) %>%
+ summarise(total = n()) %>%
+ arrange(desc(total)) %>%
+ mutate(topcount = round(total/sum(total), digits = 5), accum = cumsum(topcount))
> winecountry
# A tibble: 44 x 4
   country   total topcount accum
   <chr>     <int>    <dbl> <dbl>
 1 US        50448   0.421  0.421
 2 France    20351   0.170  0.590
 3 Italy     17921   0.149  0.740
 4 Spain      6116   0.0510 0.791
 5 Portugal   5256   0.0438 0.834
 6 Chile      4184   0.0349 0.869
 7 Argentina  3543   0.0295 0.899
 8 Austria    3033   0.0253 0.924
 9 Australia  2197   0.0183 0.942
10 Germany    1992   0.0166 0.959
# ... with 34 more rows
#begin text analysis - first remove any duplicate (since we know there is no NA in description)
> library(dplyr)

Attaching package: ‘dplyr’

The following object is masked from ‘package:car’:

    recode

The following objects are masked from ‘package:lubridate’:

    intersect, setdiff, union

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

> wine<- wine %>%
+ mutate(duplicate = duplicated(description)) %>%
+ filter(duplicate==FALSE) %>%
+ select(-duplicate)

> # look at description length

> wine$wordcount <- sapply(gregexpr("\\S+", wine$description), length)
> summary(wine$wordcount)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   3.00   33.00   40.00   40.42   47.00  135.00 
> wine$description[which(wine$wordcount == 135)]
[1] "This very fine Cabernet wants a little time in the cellar. Right now, it's tight in tannins, with some acidic bitterness in the finish. The flavors are of black currants and smoky new oak. The Morisoli Vineyard has been home to very good, ageable bottlings from the likes of Sequoia Grove and Elyse, but in the last few years, Meander has expressed its terroir best. Try after 2012.This very fine Cabernet wants a little time in the cellar. Right now, it's tight in tannins, with some acidic bitterness in the finish. The flavors are of black currants and smoky new oak. The Morisoli Vineyard has been home to very good, ageable bottlings from the likes of Sequoia Grove and Elyse, but in the last few years, Meander has expressed its terroir best. Try after 2012."
> wine$description[which(wine$wordcount == 3)]
[1] "Imported by Kobrand."
> > ggplot(data = wine, aes(x = wordcount))+
+ geom_histogram(binwidth = 5) +
+ labs(x = 'wordcount', y = 'frequency', title = " # of wordcount in description")
#graph is slightly right skewed

> ggplot(data = wine, aes(x = wine_type, y = wordcount))+
+ geom_boxplot()+
+ coord_flip()+
+ labs(title = "wordcount distribution by winetype", x = "winetype",y ="word count")

#correlation between word count and points
> ggplot(data = wine, aes(x = wordcount, y = points))+
+ geom_point()
> cor(wine$wordcount, wine$points)
[1] 0.5218238

> #difference between word described for different wine types
> pinotnoir <- subset(wine,variety == "Pinot Noir")
> descriptors <- Corpus(VectorSource(pinotnoir$description))
> head(descriptors)
<<SimpleCorpus>>
Metadata:  corpus specific: 1, document level (indexed): 0
Content:  documents: 6
> descriptors<-tm_map(descriptors, content_transformer(tolower))
Warning message:
In tm_map.SimpleCorpus(descriptors, content_transformer(tolower)) :
  transformation drops documents
> descriptors<-tm_map(descriptors, removeNumbers)
Warning message:
In tm_map.SimpleCorpus(descriptors, removeNumbers) :
  transformation drops documents
> descriptors<-tm_map(descriptors, removeWords, c("wine", "pinot", "noir", "drink", "flavors", "and", "the","with"))
Warning message:
In tm_map.SimpleCorpus(descriptors, removeWords, c("wine", "pinot",  :
  transformation drops documents
> descriptors<-tm_map(descriptors, removePunctuation)
Warning message:
In tm_map.SimpleCorpus(descriptors, removePunctuation) :
  transformation drops documents
> descriptors<-tm_map(descriptors, stripWhitespace)
Warning message:
In tm_map.SimpleCorpus(descriptors, stripWhitespace) :
  transformation drops documents
> descriptors<-tm_map(descriptors, stemDocument)
Warning message:
In tm_map.SimpleCorpus(descriptors, stemDocument) :
  transformation drops documents
> dtmpinot<-TermDocumentMatrix(descriptors)
> dtm_mat<-as.matrix(dtm)
Error in as.matrix(dtm) : object 'dtm' not found
> dtm_mat<-as.matrix(dtmpinot)
> v <- sort(rowSums(dtm_mat), decreasing = TRUE)
> d <- data.frame(word = names(v), freq=v)
> head(d, 10)
                word freq
cherry       cherry 5096
fruit         fruit 4798
acidity     acidity 3314
tannins     tannins 2970
finish       finish 2722
red             red 2694
palate       palate 2486
black         black 2433
raspberry raspberry 2268
ripe           ripe 2143
>#repeat for the cabernet sauvignon and the results are different,
> cabsav <- subset(wine, variety == "Cabernet Sauvignon")
> 
> descriptors <- Corpus(VectorSource(cabsav$description))
> 
> 
> # Convert the text to lower case
> descriptors <- tm_map(descriptors, content_transformer(tolower))
Warning message:
In tm_map.SimpleCorpus(descriptors, content_transformer(tolower)) :
  transformation drops documents
> # Remove numbers
> descriptors <- tm_map(descriptors, removeNumbers)
Warning message:
In tm_map.SimpleCorpus(descriptors, removeNumbers) :
  transformation drops documents
> # Remove english common stopwords
> descriptors <- tm_map(descriptors, removeWords, stopwords("english"))
Warning message:
In tm_map.SimpleCorpus(descriptors, removeWords, stopwords("english")) :
  transformation drops documents
> # Remove your own stop word
> # specify your stopwords as a character vector
> descriptors <- tm_map(descriptors, removeWords, c("wine", "drink", "cabernet", "flavors")) 
Warning message:
In tm_map.SimpleCorpus(descriptors, removeWords, c("wine", "drink",  :
  transformation drops documents
> # Remove punctuations
> descriptors <- tm_map(descriptors, removePunctuation)
Warning message:
In tm_map.SimpleCorpus(descriptors, removePunctuation) :
  transformation drops documents
> # Eliminate extra white spaces
> descriptors <- tm_map(descriptors, stripWhitespace)
Warning message:
In tm_map.SimpleCorpus(descriptors, stripWhitespace) :
  transformation drops documents
> # Text stemming
> #descriptors <- tm_map(descriptors, stemDocument)
> 
> # Build a term-document matrix
> dtm <- TermDocumentMatrix(descriptors)
> dtm_mat <- as.matrix(dtm)
> v <- sort(rowSums(dtm_mat),decreasing=TRUE)
> d <- data.frame(word = names(v),freq=v)
> head(d, 10)
                 word freq
tannins       tannins 3402
black           black 3162
fruit           fruit 2956
cherry         cherry 2688
finish         finish 2557
aromas         aromas 2387
oak               oak 2377
blackberry blackberry 2239
palate         palate 1978
cassis         cassis 1580
> 
> # Generate the Word cloud
> set.seed(1234)
> wordcloud(words = d$word, freq = d$freq, min.freq = 1,
+           max.words=200, random.order=FALSE, rot.per=0.35, 
+           colors=brewer.pal(8, "Dark2"))


> #split to test/train set
> set.seed(546)
> smp_size<- floor(0.8* nrow(wine))
> train_ind<- sample(seq_len(nrow(wine)), size = smp_size)
> train<- wine[train_ind, ]
> test<- wine[-train_ind, ]
> wine_explore <- wine %>% 
+     select(description, points) %>%
+     mutate(description = gsub('[[:punct:] ]+',' ',tolower(description)))
> 
> words <- str_split(wine_explore$description, ' ')
> all_words <- data.frame(points = rep(wine_explore$points, sapply(words, length)), words = unlist(words))
> words_group<- all_words %>%
+ group_by(words) %>%
+ summarise(points = mean(points), count = n()) %>%
+ filter(count >20) %>%
+ arrange(desc(points))
Warning messages:
1: In doTryCatch(return(expr), name, parentenv, handler) :
  display list redraw incomplete
2: In doTryCatch(return(expr), name, parentenv, handler) :
  invalid graphics state
3: In doTryCatch(return(expr), name, parentenv, handler) :
  invalid graphics state
> top<- words_group[1:10, ] %>% cbind(top_bottom = 'Top')
Warning messages:
1: In doTryCatch(return(expr), name, parentenv, handler) :
  display list redraw incomplete
2: In doTryCatch(return(expr), name, parentenv, handler) :
  invalid graphics state
3: In doTryCatch(return(expr), name, parentenv, handler) :
  invalid graphics state
> bottom<- words_group[(nrow(words_group)-9):nrow(words_group),] %>% cbind(top_bottom = 'bottom')
> top_bottom <- rbind(top, bottom)
> top_bottom
            words   points count top_bottom
1       2020–2035 94.47619    21        Top
2            2035 94.37500    24        Top
3         endless 94.12245    49        Top
4       2020–2032 94.07407    27        Top
5           93–95 94.00000    22        Top
6      stunningly 94.00000    35        Top
7        now–2030 93.97500    40        Top
8        incisive 93.95455    22        Top
9       2017–2030 93.84211    38        Top
10       wondrous 93.67742    31        Top
11           dull 83.37402   254     bottom
12         watery 83.36797   231     bottom
13      fruitless 83.29032    31     bottom
14          bland 83.27650   217     bottom
15        sketchy 83.19512    41     bottom
16 underdeveloped 83.00000    27     bottom
17          stale 82.89286    28     bottom
18     sauerkraut 82.78261    23     bottom
19     acceptable 82.71429    70     bottom
20          weird 82.48000    50     bottom
> define the cleaning function
Error: unexpected symbol in "define the"
> #define the cleaning function
> clean <- function(train, set) {}
> clean <- function(train, set) { 
+ prep_fun <- tolower
+ tok_fun <- function(x) {
+ word_tokenizer(x) %>% lapply(function(x) SnowballC::wordStem(x, language='en'))
+ }
+ }
> library(text2vec)
> clean <- function(train, test) {
+ prep_fun <- tolower
+ tok_fun <- function(x) {word_tokenizer(x) %>% lapply(function(x) SnowballC::wordStem(x, language='en'))}}
> it_train<- itoken(train$description, preprocessor = prep_fun, tokenizer = tok_fun, ids = train$X1, progressbar = T)
Error in .subset2(public_bind_env, "initialize")(...) : 
  object 'prep_fun' not found
> clean <- function(train, test) {
+ prep_func <- tolower
+ tok_func <- function(x) {word_tokenizer(x) %>% lapply(function(x) SnowballC::wordStem(x, language='en'))}}
> it_train<- itoken(train$description, preprocessor = prep_func, tokenizer = tok_func, ids = train$X1, progressbar = T)
Error in .subset2(public_bind_env, "initialize")(...) : 
  object 'prep_func' not found
> library(data.table)
data.table 1.12.0  Latest news: r-datatable.com

Attaching package: ‘data.table’

The following objects are masked from ‘package:dplyr’:

    between, first, last

The following objects are masked from ‘package:lubridate’:

    hour, isoweek, mday, minute, month, quarter, second, wday, week, yday, year

> prep_fun = tolower
> tok_fun = word_tokenizer
> it_train = itoken(train$description, preprocessor = prep_fun, tokenizer = tok_fun, ids = train$X1, progressbar = TRUE)
> > vocab <- create_vocabulary(it_train, stopwords = stopwords('en'), ngram =c(1L, 2L))
  |============================================================================================================| 100%
> head(vocab, 10)
Number of docs: 95964 
174 stopwords: i, me, my, myself, we, our ... 
ngram_min = 1; ngram_max = 2 
Vocabulary: 
                    term term_count doc_count
 1:     highlights_sweet          1         1
 2: grapes_indeterminate          1         1
 3:         wise_sharply          1         1
 4:           aromas_end          1         1
 5:      standard_medium          1         1
 6:       growing_cooler          1         1
 7:  countering_lushness          1         1
 8:       doling_morello          1         1
 9:      enhances_rennet          1         1
10: strawberry_medicinal          1         1
> pruned_vocab <- prune_vocabulary(vocab, term_count_min = 10, doc_proportion_max = 0.5, doc_proportion_min = 0.001)
> head(prune_vocab, 10)
Error in head(prune_vocab, 10) : object 'prune_vocab' not found
> head(pruned_vocab, 10)
Number of docs: 95964 
174 stopwords: i, me, my, myself, we, our ... 
ngram_min = 1; ngram_max = 2 
Vocabulary: 
              term term_count doc_count
 1: will_certainly         96        96
 2:         pushes         96        96
 3:   flavors_lead         96        96
 4:   palate_tight         96        96
 5:    green_plums         96        96
 6:  hints_vanilla         96        96
 7:     juicy_wild         96        96
 8:   flavors_fine         96        96
 9:   texture_rich         96        96
10:      along_way         96        96
> > #create the document term matrix
> vectorizer <-vocab_vectorizer(pruned_vocab)
> dtm_train <- create_dtm(it_train, vectorizer)
  |============================================================================================================| 100%
> #define tfidf model
tfidf <-TfIdf$new()
dtm_train_tfidf <- fit_transform(dtm_train, tfidf)
it_test <- itoken(test$description, preprocessor = prep_fun, tokenizer = tok_fun, ids = test$X1, progressbar = TRUE)
dtm_test_tfidf <- create_dtm(it_test, vectorizer) %>%
transform(tfidf)
list('train' = as.matrix(cbind(dtm_train_tfidf, train$price)), 'test' = as.matrix(cbin(dtm_test_tfidf, test$price)))
list('train' = as.matrix(cbind(dtm_train_tfidf, train$price)), 'test' = as.matrix(cbind(dtm_test_tfidf, test$price)))
